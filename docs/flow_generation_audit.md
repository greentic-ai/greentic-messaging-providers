# Flow Generation Audit

This document summarizes where `.ygtc` flows are created/copied/templated in the repo, with a focus on diagnostics flows and test fixtures. The goal is to ensure flow generation goes through the greentic-flow CLI (or a shared helper that invokes it) so schema/normalization changes require updates in a single place.

## Findings (Flow Creation / Copy / Fixtures)

- `ci/gen_flows.sh`
  - Generates flows via `greentic-messaging-packgen` (`cargo run -p greentic-messaging-packgen -- generate-all ...`).
  - Copies generated flows into `packs/*/flows`.
  - This is the primary CLI-driven generation path today.

- `crates/greentic-messaging-packgen/src/main.rs`
  - Invokes `greentic-flow` CLI for:
    - `greentic-flow new` (create flow)
    - `greentic-flow add-step`
    - `greentic-flow update-step`
    - `greentic-flow answers`
    - `greentic-flow doctor`
  - This is the main generator implementation and already uses the CLI.

- `packs/*/flows/*.ygtc`
  - Flows are committed artifacts copied from packgen output.
  - These are **not** generated in tests, but tests may copy the packs that include them.

- `crates/provider-tests/tests/pack_doctor_loads_validator.rs`
  - Copies `packs/messaging-telegram` into a temp dir for pack build/doctor tests.
  - Previously relied on committed flows and resolve sidecars.
  - Now stages local components and normalizes local component paths.
  - Updated in this change to also generate `flows/diagnostics.ygtc` via a shared greentic-flow helper.

- `crates/provider-common/tests/flow_setup_questions.rs`
  - Reads existing `packs/*/flows/setup_*.ygtc` for assertions.
  - No manual generation, but depends on committed flows.

## Tests/Fixtures Creating Temp Packs

- `crates/provider-tests/tests/pack_doctor_loads_validator.rs`
  - Temp pack creation via `copy_dir` and `fs::write`.
  - Now uses a shared CLI helper to generate `flows/diagnostics.ygtc` in the temp pack.

- `crates/provider-common/tests/pack_metadata.rs`
  - Copies packs to temp dirs for pack build/gtpack validation.
  - Does not directly generate `.ygtc` flows.

## Recommendations

- Keep all flow creation in a single CLI-driven path.
- For tests that need to mutate or generate a flow, use the shared helper in `crates/provider-tests/src/flow_gen.rs`.
- Avoid checking in hand-edited `.ygtc` files unless they are regenerated by a single script.

## Regeneration

If committed flows need regeneration:
- Run `scripts/regen_flows.sh` (wrapper around `ci/gen_flows.sh`).

